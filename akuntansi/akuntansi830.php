<?php include "../h_tetap.php";$thn=$result->c_d($_GET['thn']);$branch=$result->c_d($_GET['branch']);$fieldhari1='tahun01';$fieldhari2='tahundk';$fieldhari3='tahunkk';$fieldhari4='tahundm';$fieldhari5='tahunkm';$fieldhari6='tahun12';$thnl=$thn-1;$cabang=$result->namacabang($branch);$fieldhari11='tahun01a';$fieldhari21='tahundka';$fieldhari31='tahunkka';$fieldhari41='tahundma';$fieldhari51='tahunkma';$fieldhari61='tahun12a';$tabel='akuntansi.transaksi_'.$thn;$xuser=$userid;$t=date_sql($tanggal);$desc="Posting Jurnal Penutup Tahun : ".$thn;$file='../json/sandi.json';$nonasp='216101';$json_file = file_get_contents($file);$jfo = json_decode($json_file,TRUE);$huruf = array($nonasp);$y=0;while($y<1){$deb1=$huruf[$y];for($i=0; $i<count($jfo); $i++){if($deb1==$jfo[$i]['nonas']){$namas[$y]=$jfo[$i]['nama'];}}$y++;}$result->res("DELETE FROM $tabel WHERE jtransaksi=70");$result->res("UPDATE $tabel_sandi SET $fieldhari11=$fieldhari1,$fieldhari21=$fieldhari2,$fieldhari31=$fieldhari3,$fieldhari41=$fieldhari4,$fieldhari51=$fieldhari5,$fieldhari61=$fieldhari6");$hasil=$result->query_lap("SELECT branch,nonas,sufix,norekgl,norekgsl,norekgssl,nama,produk,kode,$fieldhari11,$fieldhari21,$fieldhari31,$fieldhari41,$fieldhari51,$fieldhari61 FROM $tabel_sandi WHERE $fieldhari61!=0 AND substr(nonas,1)>=2");$text="INSERT INTO $tabel(branch,nonas,sufix,norek,nama,norekgl,nokredit,jumlah,kdtran,jtransaksi,notransaksi,keterangan,produk,tanggal,oper,bussdate,otor,kdkredit) VALUES";while($row=$result->row($hasil)){$branch=$row['branch'];$nonas=$row['nonas'];$sufix=$row['sufix'];$noreks=$row['norekgssl'];$nama=$row['nama'];$saldo_akhir=$row[$fieldhari61];$produk='360';$xuser=$userid;if(substr($nonas,0,1)==3){$text .="('".$branch."','".$nonas."','".$sufix."','".$noreks."','".$nama."','".$noreks."',NULL,'".$saldo_akhir."',354,70,10000112,'".$desc."','".$produk."','".$t."','".$userid."',now(),'".$xuser."',99),";}elseif(substr($nonas,0,1)==4){$text .="('".$branch."','".$nonas."','".$sufix."','".$noreks."','".$nama."','".$noreks."',NULL,'".$saldo_akhir."',454,70,10000112,'".$desc."','".$produk."','".$t."','".$userid."',now(),'".$xuser."',99),";}else{if($nonas==218101){$text .="('".$branch."','".$nonas."','".$sufix."','".$noreks."','".$nama."','".$noreks."',NULL,'".$saldo_akhir."',354,70,10000112,'".$desc."','".$produk."','".$t."','".$userid."',now(),'".$xuser."',99),";$norekp=$branch.'216101360';$text .="('".$branch."','".$nonasp."',360,'".$norekp."','".$namas[0]."','".$norekp."',NULL,'".$saldo_akhir."',454,70,10000112,'".$desc."','".$produk."','".$t."','".$userid."',now(),'".$xuser."',99),";}}}$text=substr_replace($text,';',-1);$text1=$text;$text1 .= "CREATE TEMPORARY TABLE $userid SELECT branch,norekgl,tanggal,SUM(IF(substr(kdtran,1,1)='1',jumlah,0)) AS debetkas,SUM(IF(substr(kdtran,1,1)='2',jumlah,0)) AS kreditkas,SUM(IF(substr(kdtran,1,1)='3',jumlah,0)) AS debetmemo,SUM(IF(substr(kdtran,1,1)='4',jumlah,0)) AS kreditmemo FROM $tabel WHERE jtransaksi=70 GROUP BY norekgl,branch ORDER BY norekgl,branch;";$text1 .="UPDATE $tabel_sandi a JOIN $userid b ON a.norekgssl=b.norekgl SET a.$fieldhari21=a.$fieldhari21+b.debetkas,a.$fieldhari31=a.$fieldhari31+b.kreditkas,a.$fieldhari41=a.$fieldhari41+b.debetmemo,a.$fieldhari51=a.$fieldhari51+b.kreditmemo;";$text1 .="UPDATE $tabel_sandi SET $fieldhari61=IF(kode='D',$fieldhari11+$fieldhari21+$fieldhari41-$fieldhari31-$fieldhari51,$fieldhari11+$fieldhari31+$fieldhari51-$fieldhari21-$fieldhari41);";$tabelr=$userid.'5';$text1 .="CREATE TEMPORARY TABLE $tabelr SELECT norekgl,norekgsl,SUM($fieldhari21) AS $fieldhari21,SUM($fieldhari31) AS $fieldhari31,SUM($fieldhari41) AS $fieldhari41,SUM($fieldhari51) AS $fieldhari51,SUM($fieldhari61) AS $fieldhari61 FROM $tabel_sandi WHERE substr(nonas,-2)!='00' GROUP BY norekgsl ORDER BY norekgsl;";$text1 .="UPDATE $tabel_sandi a JOIN $tabelr b ON a.norekgssl=b.norekgsl SET a.$fieldhari21=b.$fieldhari21,a.$fieldhari31=b.$fieldhari31,a.$fieldhari41=b.$fieldhari41,a.$fieldhari51=b.$fieldhari51,a.$fieldhari61=b.$fieldhari61 WHERE a.norekgssl=b.norekgsl;";$tabelm=$userid.'6';$text1 .="CREATE TEMPORARY TABLE $tabelm SELECT norekgl,SUM($fieldhari21) AS $fieldhari21,SUM($fieldhari31) AS $fieldhari31,SUM($fieldhari41) AS $fieldhari41,SUM($fieldhari51) AS $fieldhari51,SUM($fieldhari61) AS $fieldhari61 FROM $tabelr  GROUP BY norekgl ORDER BY norekgl;";$text1 .="UPDATE $tabel_sandi a JOIN $tabelm b ON a.norekgssl=b.norekgl SET a.$fieldhari21=b.$fieldhari21,a.$fieldhari31=b.$fieldhari31,a.$fieldhari41=b.$fieldhari41,a.$fieldhari51=b.$fieldhari51,a.$fieldhari61=b.$fieldhari61 WHERE a.norekgssl=b.norekgl";$text=$text1;$result->multi_x($text);$result->msg_error("Posting Jurnal Penutup Akhir Tahun ".$thn." Sukses");$result->close();$catat="Posting Jurnal Penutup Tanggal : ".$tanggal;include '../around.php';?>