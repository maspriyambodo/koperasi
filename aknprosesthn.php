<?php include "h_tetap.php";$thn=$result->c_d($_POST['thn']);$fieldhari1='tahun01';$fieldhari2='tahundk';$fieldhari3='tahunkk';$fieldhari4='tahundm';$fieldhari5='tahunkm';$fieldhari6='tahun12';$thnx=$thn-1;$tabeln ='akuntansi.sandi'.$thnx;$temtran ='akuntansi.transaksi_'.$thn;$result->query_x1("UPDATE $tabel_sandi SET $fieldhari1=0,$fieldhari2=0,$fieldhari3=0,$fieldhari4=0,$fieldhari5=0,$fieldhari6=0");$result->query_x1("UPDATE $tabel_sandi a JOIN $tabeln b ON a.norekgssl=b.norekgssl SET a.$fieldhari1=b.tahun12a WHERE a.norekgssl=b.norekgssl");$result->dropTable("$temtran");$result->buatTabel($temtran,'nabasa.tem_transaksi');$y=1;for ($i = $y; $i <= 12; $i++){$blny= substr("00"."".$i,-2);$tabelm ="nabasa.tran";$tabelm .=$blny;$tabelm .=substr($thn,-2);$result->res("INSERT INTO $temtran SELECT '',branch,nonas,sufix,norek,nama,norekgl,nokredit,jumlah,kdtran,jtransaksi,notransaksi,keterangan,produk,tanggal,referensi,noreferensi,oper,otor,bussdate,kdbranch,kdkredit FROM $tabelm");}$tabel ='akuntansi.transaksi_'.$thn;$tabeln=$userid.'2';$result->tem_tabel($tabeln,'akuntansi.tem_labarugi');$text="CREATE TEMPORARY TABLE $userid SELECT branch,norekgl,tanggal,SUM(IF(substr(kdtran,1,1)='1',jumlah,0)) AS debetkas,SUM(IF(substr(kdtran,1,1)='2',jumlah,0)) AS kreditkas,SUM(IF(substr(kdtran,1,1)='3',jumlah,0)) AS debetmemo,SUM(IF(substr(kdtran,1,1)='4',jumlah,0)) AS kreditmemo FROM $temtran GROUP BY norekgl,branch ORDER BY norekgl,branch;";$hasil = $result->query_x1("SELECT kode FROM $tabel_kantor ORDER BY kode");if($result->num($hasil)!=0){while($row = $result->row($hasil)){$cabang=$row['kode'];$n=$cabang.'218101360';$text .="INSERT INTO $tabeln SELECT branch,'$n' as norekgl,tanggal,SUM(IF(substr(kdtran,1,1)='1',jumlah,0)) AS debetkas,SUM(IF(substr(kdtran,1,1)='2',jumlah,0)) AS kreditkas,SUM(IF(substr(kdtran,1,1)='3',jumlah,0)) AS debetmemo,SUM(IF(substr(kdtran,1,1)='4',jumlah,0)) AS kreditmemo FROM $tabel WHERE branch='$cabang' AND substr(norekgl,5,1)>=3 ORDER BY norekgl,branch;";$n=$cabang.'450101360';$text .="INSERT INTO $tabeln SELECT branch,'$n' as norekgl,tanggal,SUM(IF(substr(kdtran,1,1)='2',jumlah,0)) AS debetkas,SUM(IF(substr(kdtran,1,1)='1',jumlah,0)) AS kreditkas,SUM(IF(substr(kdtran,1,1)='4',jumlah,0)) AS debetmemo,SUM(IF(substr(kdtran,1,1)='3',jumlah,0)) AS kreditmemo FROM $tabel WHERE branch='$cabang' AND substr(norekgl,5,1)>=3 ORDER BY norekgl,branch;";}}else{$result->msg_error('Tabel Kantor Tidak Ada...!!');}$text .="INSERT INTO $userid SELECT branch,norekgl,tanggal,debetkas,kreditkas,debetmemo,kreditmemo FROM $tabeln;";$text .="UPDATE $tabel_sandi a JOIN $userid b ON a.norekgssl=b.norekgl SET a.$fieldhari2=b.debetkas,a.$fieldhari3=b.kreditkas,a.$fieldhari4=b.debetmemo,a.$fieldhari5=b.kreditmemo WHERE a.norekgssl=b.norekgl;";$text .="UPDATE $tabel_sandi SET $fieldhari6=IF(kode='D',$fieldhari1+$fieldhari2+$fieldhari4-$fieldhari3-$fieldhari5,$fieldhari1+$fieldhari3+$fieldhari5-$fieldhari2-$fieldhari4);";$tabelr=$userid.'5';$text .="CREATE TEMPORARY TABLE $tabelr SELECT norekgl,norekgsl,SUM($fieldhari2) AS $fieldhari2,SUM($fieldhari3) AS $fieldhari3,SUM($fieldhari4) AS $fieldhari4,SUM($fieldhari5) AS $fieldhari5,SUM($fieldhari6) AS $fieldhari6 FROM $tabel_sandi WHERE substr(nonas,-2)!='00' GROUP BY norekgsl ORDER BY norekgsl;";$text .="UPDATE $tabel_sandi a JOIN $tabelr b ON a.norekgssl=b.norekgsl SET a.$fieldhari2=b.$fieldhari2,a.$fieldhari3=b.$fieldhari3,a.$fieldhari4=b.$fieldhari4,a.$fieldhari5=b.$fieldhari5,a.$fieldhari6=b.$fieldhari6 WHERE a.norekgssl=b.norekgsl;";$tabel=$userid.'6';$text .="CREATE TEMPORARY TABLE $tabel SELECT norekgl,SUM($fieldhari2) AS $fieldhari2,SUM($fieldhari3) AS $fieldhari3,SUM($fieldhari4) AS $fieldhari4,SUM($fieldhari5) AS $fieldhari5,SUM($fieldhari6) AS $fieldhari6 FROM $tabelr GROUP BY norekgl ORDER BY norekgl;";$text .="UPDATE $tabel_sandi a JOIN $tabel b ON a.norekgssl=b.norekgl SET a.$fieldhari2=b.$fieldhari2,a.$fieldhari3=b.$fieldhari3,a.$fieldhari4=b.$fieldhari4,a.$fieldhari5=b.$fieldhari5,a.$fieldhari6=b.$fieldhari6 WHERE a.norekgssl=b.norekgl";$result->multi_x($text);$result->msg_error("Posting Transaksi Tahun : ".$thn." Sukses");$result->close();$catat="Posting Transaksi Tahun : ".$thn." Sukses"." Tanggal : ".$tanggal;include 'around.php';?>